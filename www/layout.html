<!DOCTYPE html>
<html>

<head>
    <title>Index Page</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="shortcut icon" href="img/favicon.ico" type="image/x-icon">
    <link rel="stylesheet" type="text/css" href="semantic/dist/semantic.min.css">
    <link rel="stylesheet" type="text/css" href="fontawesome/css/fontawesome.min.css">
    <link rel="stylesheet" type="text/css" href="fontawesome/css/solid.min.css">
    <script type="text/javascript" src="scripts/jquery-3.6.0.js"></script>
    <script type="text/javascript" src="semantic/dist/semantic.min.js"></script>
    <style type="text/css">
        body {
            /*overflow: hidden;*/
        }

        body>.grid {
            height: 100%;
        }

        .column {
            max-width: 450px;
        }
    </style>
</head>

<body>
    <div class="ui top fixed fluid teal inverted labeled menu">
        <a class="header item">
            <img class="ui mini image" src="img/logo.png" style="width: 24px !important;">&nbsp;&nbsp;&nbsp;<span
                style="font-size: 25px; font-weight: bold; color:white">nCare</span>
        </a>
        <div class="right icon menu">
            <a class="item" id="download">
                <span style="color: #ffffff;">
                    <i class="download yellow icon"></i>
                </span>
            </a>
            <a class="item" id="notifications">
                <span style="color: #ffffff;">
                    <i class="alarm icon"></i> <span id="ntfCount" class="ui mini red circular label"></span>
                </span>
            </a>
            <a class="item" id="signout">
                <span class="ico-width" style="color: #ffffff;">
                    <i class="fas fa-power-off fa-1x"></i>
                    <!-- <img class="ui tiny centered circular image" src="img/salad.svg" style="width: 50px !important;"> -->
                </span>
            </a>
        </div>
    </div>
    <iframe frameborder="0" width="100%" id="ifrm" seamless="" style="position: absolute" scrolling="auto"></iframe>
    <div class="ui bottom fixed fluid five item labeled icon tiny menu" style="overflow: auto;">
        <a class="item" id="profile">
            <i class="id card teal icon"></i> Profile
        </a>
        <a class="item" id="services">
            <i class="calendar plus red icon"></i> Services
        </a>
        <a class="item" id="status">
            <i class="tasks blue icon"></i> Service Status
        </a>
        <a class="item" id="reopen">
            <i class="clone brown icon"></i> ReOpen Request
        </a>
        <a class="item" id="reports">
            <i class="clipboard list green icon"></i> Reports
        </a>
    </div>
    <input type="hidden" id="regno" />
    <input type="hidden" id="hsid" />
    <input type="hidden" id="hsname" />
    <input type="hidden" id="hfname" />
    <input type="hidden" id="hvno" />
    <input type="hidden" id="hano" />
    <div class="ui active inverted page dimmer">
        <div class="ui large text loader">Loading</div>
    </div>
</body>

</html>
<script type="text/javascript" src="scripts/phonegap-1.1.0.js"></script>
<script type="text/javascript" src="cordova.js"></script>
<script type="text/javascript">
    var apiURL = '../../NnoteApi/api/';
    //var apiURL = 'http://115.241.194.19/NnoteApi/api/';

    document.addEventListener("deviceready", onDeviceReady, false);

    function onDeviceReady() {
        document.addEventListener("backbutton", function (e) {
            e.preventDefault();
        }, false);
    }
    var qsParm = new Array();

    function qs() {
        //debugger;
        var query = window.location.search.substring(1);
        var parms = query.split('&');
        for (var i = 0; i < parms.length; i++) {
            var pos = parms[i].indexOf('=');
            if (pos > 0) {
                var key = parms[i].substring(0, pos);
                var val = parms[i].substring(pos + 1);
                qsParm[key] = val;
            }
        }
        if (parms.length > 0) {
            $("#regno").val(atob(qsParm["regno"]));
            if (qsParm["fname"] != null || qsParm["fname"] != undefined) {
                $("#hsid").val(atob(qsParm["sid"]));
                $("#hsname").val(atob(qsParm["sname"]));
                $("#hfname").val(atob(qsParm["fname"]));
            } else if (qsParm["ano"] != null || qsParm["ano"] != undefined) {
                $("#hano").val(atob(qsParm["ano"]));
            }
            return true;
        } else {
            window.location.href = 'index.html';
            return false;
        }
    }

    function isPhoneGap() {
        return (window.cordova || window.PhoneGap || window.phonegap) &&
            /^file:\/{3}[^\/]/i.test(window.location.href) &&
            /ios|iphone|ipod|ipad|android/i.test(navigator.userAgent);
    }
    /*
    var timeout = setInterval(function runMe() {
        //debugger;
        ShowAppUpdate();
    }, 60000);
    */

    $(document).ready(function () {
        qs();
        $(".dimmer").hide();
        $('#download').hide();
        $.get("./version.xml", function (data) {}).done(function (result) {
            var version = $(result).find('content').attr('version');
            $("#hvno").val(version);
        }).fail(function (jqxhr, settings, ex) {
            alert('Failed: ' + ex);
        });

        var ifrmheight = $('body').height() - $('.bottom').height();
        $('#ifrm').css('top', $('.top').height());
        $('#ifrm').height(ifrmheight - 55);

        if ($("#hfname").val() != "")
            $('#ifrm').attr('src', 'request.html?regno=' + btoa($("#regno").val()) + "&sid=" + btoa($("#hsid").val()) + "&sname=" + btoa($("#hsname").val())
            + "&fname=" + btoa($("#hfname").val()));
        else if ($("#hano").val() != "")
            $('#ifrm').attr('src', 'AssetTrans.html?regno=' + btoa($("#regno").val()) + "&ano=" + btoa($("#hano").val()));
        else
            $('#ifrm').attr('src', 'profile.html?regno=' + btoa($("#regno").val()));

        $("#ntfCount").text("");
        $("#ntfCount").hide();

        $('#notifications').click(function () {
            //$('#ifrm').attr('src', 'notifications.html?regno=' + btoa($("#regno").val()));
        });
        $('#signout').click(function () {
            $.get(apiURL + 'User/LogOut/' + $("#regno").val(), function (response) {
                window.location.href = 'index.html';
            }).fail(function () {
                window.location.href = 'index.html';
            });
        });

        $('#profile').click(function () {
            $('#ifrm').attr('src', 'profile.html?regno=' + btoa($("#regno").val()));
        });
        $('#services').click(function () {
            $('#ifrm').attr('src', 'services.html?regno=' + btoa($("#regno").val()));
        });
        $('#status').click(function () {
            $('#ifrm').attr('src', 'editrequest.html?regno=' + btoa($("#regno").val()));
        });
        $('#reopen').click(function () {
            $('#ifrm').attr('src', 'reopen.html?regno=' + btoa($("#regno").val()));
        });
        $('#reports').click(function () {
            $('#ifrm').attr('src', 'labreports.html?regno=' + btoa($("#regno").val()));
        });

        //ShowNotifications();        
    });

    function ShowNotifications() {
        $.get(apiURL + 'Notifications/' + $("#regno").val(), function (response) {
            //debugger;
            var arrdata = response.data;
            if (arrdata.length > 0) {
                selectedArray = jQuery.grep(arrdata, function (data, i) {
                    //debugger;
                    return data.Status == 1;
                });

                if (selectedArray.length > 0) {
                    $("#ntfCount").text(selectedArray.length);
                    $("#ntfCount").show();
                } else {
                    $("#ntfCount").text("");
                    $("#ntfCount").hide();
                }
            } else {
                $("#ntfCount").text("");
                $("#ntfCount").hide();
            }
        }).fail(function () {
            setTimeout(ShowNotifications(), 3000);
        });
    }

    function ShowAppUpdate() {
        $('#download').hide();
        $.get(apiURL + 'Notifications/App/4029038', function (response) {
            //debugger;
            var arrdata = response.data;
            if (arrdata != $("#hvno").val()) {
                if (isPhoneGap()) {
                    $('#download').show();
                    $('#download').click(function () {
                        $(this).attr('href', 'http://115.241.194.19/nNote.apk');
                    });
                }
            }
        }).fail(function () {
            //setTimeout(ShowAppUpdate(), 60000);
        });
    }
</script>